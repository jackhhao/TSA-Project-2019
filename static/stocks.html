<!DOCTYPE HTML>
<!--
	Theory by TEMPLATED
	templated.co @templatedco
	Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)
-->
<html>
	<head>
		<title>Generic - Theory by TEMPLATED</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="../assets/main.css" />
	</head>
	<body class="subpage">
		<!-- Header -->
			<header id="header">
				<div class="inner">
					<a href="/theory" class="logo">Theory</a>
					<nav id="nav">
						<a href="/">Home</a>
						<a href="/stocks">Stocks</a>
						<a href="/portfolio">Portfolio</a>
					</nav>
					<a href="#navPanel" class="navPanelToggle"><span class="fa fa-bars"></span></a>
				</div>
			</header>

		<!-- Three -->
			<section id="three" class="wrapper">
				<div class="inner">
					<header class="align-center">
						<h2>Random Stocks</h2>
						<p>After sorting through random stocks, we display the ones we think are the best!</p>
					</header>
					<p><center>Input how many stocks you would like to go through and press the submit button. The computer will randomly generate stocks and recommend you the best ones.</center></p>
					<div class="flex flex-2" id = "flex-div"></div>

						<div id = "modals"></div>

<!-- Link to open the modal -->
						<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
						<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
						<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css"/>
						<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

						<div class = "container">
						</div>
						<div class = container-fluid>

							Number of Stocks: <input type="number" id="field1">
							<button id = "btn1" onclick="generateRandom()">Submit</button>
							<div id = "suggestions">
									<h2>We Recommend</h2>
							</div>
						</div>

						<script>

						let count = 0

						let dict = {}

						let sug = document.getElementById("suggestions")

						function generateRandom(){
							let rows = 0
							let cols = 3
							let rowsFill = parseInt(document.getElementById("field1").value);
							$("#flex-div").append(`<table id = "stockTable" class = "tableVals"></table>`)
							$("#stockTable").empty()
							$('#stockTable div').html('');
							$("#stockTable").append(`<tr id = "headers">
								<th id = "tickerHeader"><center>Stock Ticker</center></th>
								<th id = "priceHeader"><center>Current Price</center></th>
								<th id = "ratingHeader"><center>Our Rating</center></th>
							</tr>`)
							console.log("bruh")
							console.log(rowsFill)

							for(let i = 0; i < rowsFill; i++){
								$("#stockTable").append(`<tr class = "row${i + 1}" id = "row${i+1}"></tr>`);
								console.log(`<tr class=row${i + 1}>`);
								for (let j = 0; j < cols; j++)
								{
									var rowID;
									switch(j)
									{
										case 0:
											rowID = `t${i + 1}`
											break;
										case 1:
											rowID = `p${i + 1}`
											break;
										case 2:
											rowID = `r${i + 1}`
											break;
									}
									$(`#row${i+1}`).append(`<td id = "${rowID}"><center></center></td>`)
									console.log(`<td id = "${rowID}"><center>AAPL</center></td>`);
								}
								console.log(document.getElementById("stockTable").innerHTML);
							}

							let r=1;
							let table = document.getElementById("stockTable");
							while(row=table.rows[r++])
							{
							  let c=0;
							  while(cell=row.cells[c++]){cell.innerHTML="";}
							}
							for(let x = 1; x < rowsFill + 1; x++){
								setT(x)
							}
						}

						function sleep(miliseconds) {
                var currentTime = new Date().getTime();
                while (currentTime + miliseconds >= new Date().getTime()) {
                }
            }

						function getVt(ticker){
							$.get("/volatility", {v:ticker}, function (output){
								console.log("ok it worked")
								dict[`volatility${ticker}`] = output
							})
						}

						function getVl(ticker){
							$.get("/volume", {v:ticker}, function (output){
								dict[`volume${ticker}`] = output
							})
						}

						function getBeta(ticker){
							$.get("/beta", {v:ticker}, function (output){
								console.log("ok it worked")
								dict[`beta${ticker}`] = output
							})
						}

						function setT(rowNum){
							$ .get  ("/random", {}, function(result) {
								document.getElementById(`t${rowNum}`).textContent = result
								setP(rowNum, result)
								setR(rowNum, result)
							})
						}

						function setP(rowNum, ticker){
							$.get("/price", {v: ticker}, function(result){
								let newResult;
								if (!(isNaN(result)))
								{
									newResult = "$" + parseFloat(result).toFixed(2).toString();
								}
								else
								{
									newResult = "None";
								}
								$("#" + `p${rowNum}`).text(newResult);
							})
						}

						function setR(rowNum, ticker){
							$.get("/suggest", {v: ticker}, function(result){
								$ ("#" + `r${rowNum}`).text(parseFloat(result).toFixed(4).toString());
								if(parseFloat(result) >= 50	){
									let modal = document.createElement("div")
									let overlay = document.createElement("div")
									let modal_content = document.createElement("div")
									modal.setAttribute("class", "modal")
									modal.setAttribute("id", `stockModal${ticker}`)
									overlay.setAttribute("class", "overlay")
									modal_content.setAttribute("class", "modal_content")
									getVt(ticker)
									getVl(ticker)
									getBeta(ticker)
									let h3 = document.createElement("h3")
									let header = document.createTextNode(`Stock: ${ticker}`)
									h3.appendChild(header)
									let p = document.createElement("p")
									p.setAttribute("id", `content${ticker}`)
									modal_content.appendChild(h3)
									modal_content.appendChild(p)
									overlay.appendChild(modal_content)
									modal.appendChild(overlay)
									let modals = document.getElementById("modals")
									modals.appendChild(modal)
									$("#suggestions").append(`<p><a href = "#stockModal${ticker}" rel = "modal:open" onclick = `+`'fillModal("${ticker}")'`+`>${ticker}</a></p>`)
							 }
							})
						}

						function appendLS(ticker){
							str_count = localStorage.getItem("count");
					    if (str_count == null || str_count == "null"){
					      count = 0;
					    } else {
					      count = parseInt(str_count);
					    }
					    count++;

					    localStorage.setItem("count", count);
							localStorage.setItem(`stock${count}`, ticker)
						}

						function fillModal(ticker){
							$(`#content${ticker}`).empty()
							$.get("/createCS", {v: ticker}, () => {})
							let p = document.getElementById(`content${ticker}`)
							let vt = document.createTextNode(`Volatility: ${dict[`volatility${ticker}`]}`)
							let br = document.createElement("br")
							let vl = document.createTextNode(`Volume: ${dict[`volume${ticker}`]}`)
							let br2 = document.createElement("br")
							let b = document.createTextNode(`Beta: ${dict[`beta${ticker}`]}`)
							let br3 = document.createElement("br")
							let img = document.createElement("img")
							let img2 = document.createElement("img")
							let button = document.createElement("button")
							let bText = document.createTextNode("Add to Portfolio")
							button.setAttribute("onclick", `appendLS('${ticker}')`)
							button.appendChild(bText)
							sleep(10000)
							img.setAttribute("src", `../assets/images/chartSeries${ticker}.jpg`)
							img.setAttribute("id",`${ticker}Img`)
							d = new Date();
							$(`#${ticker}Img`).attr("src", `../assets/images/chartSeries${ticker}.jpg`+d.getTime());
							p.appendChild(vt)
							p.appendChild(br)
							p.appendChild(vl)
							p.appendChild(br2)
							p.appendChild(b)
							p.appendChild(br3)
							p.appendChild(img)
							p.append(button)
						}

						let input = document.getElementById("field1");
						input.addEventListener("keyup", function(event) {
							if (event.keyCode === 13) {
							 event.preventDefault();
							 document.getElementById("btn1").click();
							}
						});

						</script>


		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>
